version: "3.9"

networks:
  nifi-net:
    driver: bridge

services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
    ports:
      - "2181:2181"
    networks:
      - nifi-net

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    ports:
      - "9092:9092"
      - "9093:9093"
    networks:
      - nifi-net

  mysql:
    image: mysql:8.0
    container_name: mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: testdb
      MYSQL_USER: test
      MYSQL_PASSWORD: test
    ports:
      - "3307:3306"
    volumes:
      - ./mysql-data:/var/lib/mysql
      - ./mysql-init:/docker-entrypoint-initdb.d
    networks:
      - nifi-net

  nifi:
    image: apache/nifi:1.27.0
    container_name: nifi
    restart: always
    #build: ./nifi_debug
    environment:
      NIFI_WEB_HTTP_PORT: 8080
      NIFI_JVM_DEBUG: "true"
      NIFI_JVM_DEBUG_PORT: "5005"
 
      # SINGLE_USER_CREDENTIALS_USERNAME: "admin"
      # SINGLE_USER_CREDENTIALS_PASSWORD: "123456aA@"
      NIFI_WEB_CSRF_PROTECTION_ENABLED: "false"
      NIFI_REGISTRY_URL: http://nifi-registry:18080S
    ports:
      - "8080:8080"
      - "8081:8081"
      - "5005:5005" 
    depends_on:
      - kafka
      - mysql
      - nifi-registry
    volumes:
      - ./nifi_conf:/opt/nifi/nifi-current/conf
      - ./nifi_database_repository:/opt/nifi/nifi-current/database_repository
      - ./nifi_flowfile_repository:/opt/nifi/nifi-current/flowfile_repository
      - ./nifi_content_repository:/opt/nifi/nifi-current/content_repository
      - ./nifi_provenance_repository:/opt/nifi/nifi-current/provenance_repository
      - ./nifi_state:/opt/nifi/nifi-current/state
      - ./nifi_extensions:/opt/nifi/nifi-current/extensions
      - ./nifi_drivers/mysql-connector-j-8.0.33.jar:/opt/nifi/nifi-current/lib/mysql-connector-j-8.0.33.jar
    networks:
      - nifi-net

  nifi-registry:
    image: apache/nifi-registry:1.27.0
    container_name: nifi-registry
    ports:
      - "18080:18080"
    environment:
      NIFI_REGISTRY_WEB_HTTP_PORT: 18080
    restart: always
    volumes:
      # KHÔNG mount conf vì gây lỗi
      - ./nifi_registry_database:/opt/nifi-registry/nifi-registry-current/database
      - ./nifi_registry_flow_storage:/opt/nifi-registry/nifi-registry-current/flow_storage
    networks:
      - nifi-net

  mock-api:
    image: node:18
    container_name: mock-api
    working_dir: /app
    volumes:
      - ./mock-api:/app
    command: >
      sh -c "npm install express && node server.js"
    ports:
      - "9000:9000"
    networks:
      - nifi-net